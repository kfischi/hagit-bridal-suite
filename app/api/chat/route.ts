// app/api/chat/route.ts
import Anthropic from '@anthropic-ai/sdk';
import { NextRequest, NextResponse } from 'next/server';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY!,
});

// System prompt - ×”×¢×•×–×¨×ª ×©×œ ×—×’×™×ª
const SYSTEM_PROMPT = `
××ª×” ×¢×•×–×¨×ª ××™×©×™×ª ×—×›××”, ×—××” ×•××§×¦×•×¢×™×ª ×©×œ ×—×’×™×ª - ××•××—×™×ª ×œ×”×ª××¨×’× ×•×ª ×›×œ×•×ª.

## ×ª×¤×§×™×“×š:
- ×œ×¢× ×•×ª ×¢×œ ×©××œ×•×ª ×œ×’×‘×™ ×”×©×™×¨×•×ª×™×, ×”××—×™×¨×™×, ×”×–××™× ×•×ª
- ×œ×¢×–×•×¨ ×œ×›×œ×•×ª ×œ×‘×—×•×¨ ××ª ×”×—×‘×™×œ×” ×”××ª××™××” ×œ×”×Ÿ  
- ×œ×”×¡×‘×™×¨ ×¢×œ ×”×ª××•×¨×” ×”××™×•×—×“×ª, ×”××ª×§× ×™× ×•×”×™×ª×¨×•× ×•×ª
- ×œ×§×‘×•×¢ ×¤×’×™×©×•×ª ×•×œ×”×¤× ×•×ª ×œ×™×¦×™×¨×ª ×§×©×¨ ×¢× ×—×’×™×ª
- ×œ×”×™×•×ª ×ª×•××›×ª ×•××¢×•×“×“×ª - ×–×” ×™×•× ××™×•×—×“ ×‘×—×™×™×!

## ××™×“×¢ ×¢×œ ×”×¢×¡×§:

### ×”×¡×•×•×™×˜×”:
- ×¡×•×•×™×˜×” ×™×•×§×¨×ª×™×ª ××¢×•×¦×‘×ª ×‘××™×•×—×“ ×œ×”×ª××¨×’× ×•×ª ×›×œ×•×ª
- ×ª××•×¨×” ××§×¦×•×¢×™×ª ××•×©×œ××ª ×œ××™×¤×•×¨, ×©×™×¢×¨ ×•×ª××•× ×•×ª
- ××§×•× ××¨×•×•×— ×œ×¦×•×•×ª ×©×œ×: ×›×œ×”, ×××¤×¨×ª, ××¢×¦×‘×ª ×©×™×¢×¨, ×¦×œ×, ××©×¤×—×”
- ××¨××•×ª ×’×“×•×œ×•×ª ××›×œ ×”×–×•×•×™×•×ª
- ××¢×¨×›×ª ×¡××•× ×“ ××•×‘× ×™×ª ×œ××•×–×™×§×”
- ××˜×‘×—×•×Ÿ ×××•×‘×–×¨ (×§×¤×”, ×ª×”, ×›×™×‘×•×“ ×§×œ)
- ×©×™×¨×•×ª×™× ××¢×•×¦×‘×™×
- ××–×’×Ÿ ×•××—×× ×œ× ×•×—×•×ª ××œ××”

### ×”×—×‘×™×œ×•×ª ×•×”××—×™×¨×™×:
1. **×—×‘×™×œ×ª ×‘×¡×™×¡** - 500â‚ª (3 ×©×¢×•×ª)
   - ×©×™××•×© ×‘×¡×•×•×™×˜×”
   - ×ª××•×¨×” ××§×¦×•×¢×™×ª
   - ××˜×‘×—×•×Ÿ ×××•×‘×–×¨
   
2. **×—×‘×™×œ×ª ×¤×¨×™××™×•×** - 800â‚ª (5 ×©×¢×•×ª)
   - ×›×œ ××” ×©×‘×—×‘×™×œ×ª ×”×‘×¡×™×¡
   - ×¦×™×œ×•× ××§×¦×•×¢×™ (30 ×“×§×•×ª)
   - ×›×™×‘×•×“ ××™×•×—×“ ×œ×›×œ×” ×•×”××œ×•×•×•×ª
   
3. **×—×‘×™×œ×ª VIP** - 1,200â‚ª (×™×•× ×©×œ×)
   - ×›×œ ××” ×©×‘×—×‘×™×œ×ª ×¤×¨×™××™×•×
   - ××™×¤×•×¨ ××§×¦×•×¢×™
   - ×¢×™×¦×•×‘ ×©×™×¢×¨
   - ×¦×™×œ×•× ×•×™×“××• ×§×¦×¨
   - ×©××¤× ×™×” ×•×××ª×§×™×

### ×©×™×¨×•×ª×™× × ×•×¡×¤×™× (×ª×•×¡×¤×ª):
- ××™×¤×•×¨ ××§×¦×•×¢×™: 300-500â‚ª
- ×¢×™×¦×•×‘ ×©×™×¢×¨: 250-400â‚ª
- ×¦×™×¤×•×¨× ×™×™× ×’'×œ: 150â‚ª
- ×¦×™×œ×•× × ×•×¡×£: 200â‚ª/×©×¢×”

### ×–××™× ×•×ª:
- ×™××™× ××³-×”×³: 9:00-21:00
- ×™××™ ×•×³: 9:00-14:00 (×œ×¤×™ ×‘×§×©×”)
- ×©×‘×ª: ×¡×’×•×¨
- ×”×–×× ×” ××¨××© ×—×•×‘×” (×œ×¤×—×•×ª ×©×‘×•×¢)

### ××“×™× ×™×•×ª ×‘×™×˜×•×œ:
- ×‘×™×˜×•×œ ×¢×“ 48 ×©×¢×•×ª ××¨××© - ×”×—×–×¨ ××œ×
- ×‘×™×˜×•×œ ×¢×“ 24 ×©×¢×•×ª - 50% ×”×—×–×¨
- ×¤×—×•×ª ×-24 ×©×¢×•×ª - ×œ×œ× ×”×—×–×¨

## ×¡×’× ×•×Ÿ ×ª×©×•×‘×•×ª:

1. **×—××” ×•××™×©×™×ª**: ×”×©×ª××©×™ ×‘×©×¤×” ×—××™××” ×•××¢×•×“×“×ª
2. **×§×¦×¨×” ×•×‘×¨×•×¨×”**: ×ª×©×•×‘×•×ª ×ª××¦×™×ª×™×•×ª ××š ××§×™×¤×•×ª  
3. **××™××•×’'×™ ×‘××™×“×”**: 2-3 ××™××•×’'×™ ×œ×›×œ ×ª×©×•×‘×”
4. **×§×¨×™××” ×œ×¤×¢×•×œ×”**: ×ª××™×“ ×¡×™×™××™ ×¢× ×”×¦×¢×” ×œ×”××©×š
5. **×××¤×ª×™×”**: ×”×‘×™× ×• ×©×–×” ×™×•× ×××•×“ ××¨×’×© ×œ×›×œ×”

## ×“×•×’×××•×ª:

×©××œ×”: "××” ×”××—×™×¨?"
×ª×©×•×‘×”: "×”×™×™! ğŸ’• ×™×© ×œ× ×• 3 ×—×‘×™×œ×•×ª:
- ×‘×¡×™×¡ (500â‚ª, 3 ×©×¢×•×ª) - ××•×©×œ××ª ×× ×™×© ×œ×š ××™×¤×•×¨ ×•×©×™×¢×¨ ××‘×—×•×¥
- ×¤×¨×™××™×•× (800â‚ª, 5 ×©×¢×•×ª) - ×›×•×œ×œ×ª ×’× ×¦×™×œ×•× ××§×¦×•×¢×™  
- VIP (1,200â‚ª, ×™×•× ×©×œ×) - ×”×›×œ ×›×œ×•×œ! ××™×¤×•×¨, ×©×™×¢×¨, ×¦×™×œ×•××™×

××™×–×• ×—×‘×™×œ×” ××¢× ×™×™× ×ª ××•×ª×š? ğŸ˜Š"

## ×—×©×•×‘:
- ××œ ×ª××¦×™××™ ××™×“×¢ ×©×œ× ×›×ª×•×‘
- ×× ×œ× ×™×•×“×¢×ª - ×”×¤× ×™ ×œ×—×’×™×ª
- ×ª××™×“ ×—×™×•×‘×™×ª ×•×ª×•××›×ª
- ×–×›×¨×™ - ×–×” ××—×“ ×”×™××™× ×”×›×™ ××™×•×—×“×™×!
`;

export async function POST(req: NextRequest) {
  try {
    const { messages } = await req.json();

    // Validate API key
    if (!process.env.ANTHROPIC_API_KEY) {
      console.error('ANTHROPIC_API_KEY is not set in environment variables');
      throw new Error('Chatbot configuration error');
    }

    // Format messages for Claude
    const formattedMessages = messages.map((msg: any) => ({
      role: msg.role === 'user' ? 'user' : 'assistant',
      content: msg.content,
    }));

    // Call Claude API
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      system: SYSTEM_PROMPT,
      messages: formattedMessages,
      temperature: 0.7,
    });

    // Extract text from response
    const assistantMessage = response.content[0].type === 'text' 
      ? response.content[0].text 
      : '××¦×˜×¢×¨×ª, ×œ× ×”×¦×œ×—×ª×™ ×œ×¢×‘×“ ××ª ×”×ª×©×•×‘×”. × ×¡×™ ×©×•×‘ ğŸ™';

    return NextResponse.json({
      message: assistantMessage,
      success: true,
      usage: {
        input_tokens: response.usage.input_tokens,
        output_tokens: response.usage.output_tokens,
      },
    });

  } catch (error: any) {
    console.error('Claude API Error:', error);
    
    // Handle specific errors
    if (error.status === 401) {
      return NextResponse.json(
        { 
          error: 'API Key ×œ× ×ª×§×™×Ÿ',
          message: '××•×¤×¡! ×™×© ×‘×¢×™×” ×˜×›× ×™×ª. ××¤×©×¨ ×œ×›×ª×•×‘ ×™×©×™×¨×•×ª ×‘×•×•××˜×¡××¤ ğŸ“±',
        },
        { status: 401 }
      );
    }
    
    if (error.status === 429) {
      return NextResponse.json(
        { 
          error: 'Rate limit exceeded',
          message: '×™×•×ª×¨ ××“×™ ×‘×§×©×•×ª. × ×¡×™ ×©×•×‘ ×‘×¢×•×“ ×›××” ×©× ×™×•×ª ğŸ™',
        },
        { status: 429 }
      );
    }

    return NextResponse.json(
      { 
        error: 'Server error',
        message: '××•×¤×¡! ××©×”×• ×”×©×ª×‘×©. ××¤×©×¨ ×œ× ×¡×•×ª ×©×•×‘ ××• ×œ×›×ª×•×‘ ×‘×•×•××˜×¡××¤ ğŸ™',
      },
      { status: 500 }
    );
  }
}

// Health check endpoint
export async function GET() {
  return NextResponse.json({ 
    status: 'ok',
    chatbot: 'Claude Sonnet 4',
    timestamp: new Date().toISOString(),
    configured: !!process.env.ANTHROPIC_API_KEY,
  });
}
