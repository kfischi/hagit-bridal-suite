import { Anthropic } from '@anthropic-ai/sdk';
import { NextResponse } from 'next/server';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY || '',
});

export const runtime = 'edge';

export async function POST(req: Request) {
  try {
    // ×× ×—× ×• ×§×•×œ×˜×™× ×’× ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”×”×•×“×¢×•×ª (×‘×©×‘×™×œ ×”×–×™×›×¨×•×Ÿ) ×•×’× ××ª ×”××˜×¨×” (×‘×©×‘×™×œ ×”×¡×™×›×•×)
    const { messages, purpose } = await req.json();

    if (!process.env.ANTHROPIC_API_KEY) {
      return NextResponse.json({ reply: "×”××¢×¨×›×ª ×‘×”×§××”, × ×¡×™ ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨ :)" }, { status: 500 });
    }

    // --- ×ª×¨×—×™×© 1: ×™×¦×™×¨×ª ×¡×™×›×•× ×œ×•×•××˜×¡××¤ (×›×©×”×›×œ×” ×œ×•×—×¦×ª ×¢×œ ×”×›×¤×ª×•×¨ ×”×™×¨×•×§) ---
    if (purpose === 'summary') {
      const summaryPrompt = `
        ××ª ×”×¢×•×–×¨×ª ×”××™×©×™×ª ×”×—×›××” ×©×œ ×—×’×™×ª.
        ×”××©×™××”: ×œ×¡×›× ××ª ×”×©×™×—×” ×œ×”×•×“×¢×ª ×•×•××˜×¡××¤ ×§×¦×¨×” ×©×”×›×œ×” ×ª×©×œ×— ×œ×—×’×™×ª.
        
        ×›×ª×‘×™ *×¨×§* ××ª ×ª×•×›×Ÿ ×”×”×•×“×¢×” (×‘×œ×™ "×”× ×” ×”×¡×™×›×•×"):
        "×”×™×™ ×—×’×™×ª, ×“×™×‘×¨×ª×™ ×¢× ×”×‘×•×˜ ×‘××ª×¨ ×•××©××— ×œ×©×¨×™×™×Ÿ ×ª××¨×™×š! ğŸ’
        
        ğŸ“‹ ×”×¤×¨×˜×™× ×©×œ×™:
        - ×ª××¨×™×š ××‘×•×§×©: [××” ×©×”×•×–×›×¨ ×‘×©×™×—×”, ××• "×˜×¨× × ×§×‘×¢"]
        - ×›××•×ª ××œ×•×•×ª: [××” ×©×”×•×–×›×¨, ××• "×˜×¨× × ×§×‘×¢"]
        - ×—×‘×™×œ×” ××•×¢×“×¤×ª: [×‘×¡×™×¡/×¤×¨×™××™×•×/×”×›×œ ×›×œ×•×œ - ×× ×”×•×–×›×¨]
        
        ××©××— ×©×ª×—×–×¨×™ ××œ×™ ×œ××™×©×•×¨ ×¡×•×¤×™! ×ª×•×“×”."
      `;

      const response = await anthropic.messages.create({
        model: 'claude-3-haiku-20240307',
        max_tokens: 300,
        messages: [
           // ×©×•×œ×—×™× ×œ-AI ××ª ×›×œ ×”×©×™×—×” ×›×“×™ ×©×™×“×¢ ××” ×œ×¡×›×
           ...messages.map((msg: any) => ({ role: msg.role === 'user' ? 'user' : 'assistant', content: msg.content })),
           { role: "user", content: summaryPrompt }
        ]
      });
      
      const text = response.content[0].type === 'text' ? response.content[0].text : '';
      return NextResponse.json({ reply: text });
    }

    // --- ×ª×¨×—×™×© 2: ×©×™×—×” ×©×•×˜×¤×ª (× ×™×”×•×œ ××›×™×¨×”) ---
    const systemPrompt = `
      ××ª ×—×’×™×ª, ×”×‘×¢×œ×™× ×©×œ "×¡×•×•×™×˜×ª ×›×œ×•×ª" ×‘×©×•×¨×©.
      ×”××˜×¨×” ×©×œ×š: **×œ×¡×’×•×¨ ×¢×¡×§×”** ×•×œ×”×•×‘×™×œ ××ª ×”×›×œ×” ×œ×œ×—×•×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×¡×™×›×•× ×œ×•×•××˜×¡××¤.
      
      ×”××•×¤×™ ×©×œ×š: ×—××”, ××™××”×™×ª, ×§×¦×¨×” ×•×œ×¢× ×™×™×Ÿ. ××©×ª××©×ª ×‘××™××•×’'×™× (âœ¨, ğŸ¤).
      
      ×”×ª×¡×¨×™×˜ ×©×œ×š (××œ ×ª×©××œ×™ ×”×›×œ ×‘×™×—×“! ×©××œ×” ××—×ª ×‘×›×œ ×¤×¢×):
      1. ×× ×œ× ×™×“×•×¢ ×ª××¨×™×š -> ×ª×©××œ×™ ××ª×™ ×”×—×ª×•× ×”.
      2. ×× ×œ× ×™×“×•×¢ ×›××•×ª -> ×ª×©××œ×™ ×›××” ××œ×•×•×ª ×™×”×™×•.
      3. ×”×¦×™×¢×™ ×—×‘×™×œ×” -> ×œ×¤×™ ××” ×©××ª××™× ×œ×” (×¨××™ ××—×™×¨×•×Ÿ).
      4. ×¡×’×™×¨×” -> ×”×¦×™×¢×™ ×œ×” ×œ×œ×—×•×¥ ×¢×œ ×›×¤×ª×•×¨ ×”×¡×™×›×•× ×›×“×™ ×œ×©×¨×™×™×Ÿ ××™×ª×š ×‘×•×•××˜×¡××¤.

      ×”××—×™×¨×•×Ÿ ×”×—×“×© ×•×”××¢×•×“×›×Ÿ:
      - **×—×‘×™×œ×ª ×‘×¡×™×¡ (1,800 â‚ª):** ×•×™×œ×” ×œ×›×œ ×”×™×•× + ×›×™×‘×•×“ ×§×œ ×•×™×™×Ÿ.
      - **×—×‘×™×œ×ª ×¤×¨×™××™×•× (2,200 â‚ª - ×”××•××œ×¦×ª!):** ×›×•×œ×œ×ª ×’× ××¨×•×—×ª ×‘×•×§×¨ ×¢×©×™×¨×” ×•×©××¤× ×™×”. (×”×›×™ ××©×ª×œ××ª).
      - **×—×‘×™×œ×ª ×”×›×œ ×›×œ×•×œ (×”×—×œ ×-6,500 â‚ª):** ×›×•×œ×œ×ª ×’× ×¡×¤×§×™× (×¦×œ×, ××™×¤×•×¨, ×©×™×¢×¨).

      ×—×©×•×‘: ×”×ª×©×•×‘×•×ª ×—×™×™×‘×•×ª ×œ×”×™×•×ª ×§×¦×¨×•×ª (2-3 ××©×¤×˜×™× ×’×’). ×ª××™×“ ×ª×¡×™×™××™ ×‘×©××œ×” ×©××§×“××ª ××ª ×”×©×™×—×”.
    `;

    const response = await anthropic.messages.create({
      model: 'claude-3-haiku-20240307',
      max_tokens: 400,
      system: systemPrompt, // ×”×’×“×¨×ª "×”××•×—" ×©×œ ×—×’×™×ª
      messages: messages.map((msg: any) => ({
        role: msg.role === 'user' ? 'user' : 'assistant',
        content: msg.content
      }))
    });

    const replyContent = response.content[0];
    const text = replyContent.type === 'text' ? replyContent.text : '';

    return NextResponse.json({ reply: text });

  } catch (error) {
    console.error('API Error:', error);
    // ×”×•×“×¢×ª ×©×’×™××” ×™×“×™×“×•×ª×™×ª ×œ××§×¨×” ×©×”×©×¨×ª × ×•×¤×œ
    return NextResponse.json({ reply: "××•×™, ×”××™× ×˜×¨× ×˜ ×©×œ×™ ×§×¦×ª ×—×œ×© ×‘×”×¨×™× ×›×¨×’×¢. ×‘×•××™ × ×“×‘×¨ ×™×©×¨ ×‘×•×•××˜×¡××¤! (×œ×—×¦×™ ×¢×œ ×”×›×¤×ª×•×¨ ×”×™×¨×•×§ ×œ××˜×”) ğŸ’–" }, { status: 500 });
  }
}
